<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Otman 3D – Kış Motoru</title>

<style>
  html, body {
    margin: 0;
    overflow: hidden;
    width: 100%;
    height: 100%;
    background: #000;
    font-family: sans-serif;
  }

  #uiTop {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 16px;
    background: rgba(0,0,0,0.45);
    border-radius: 10px;
    color: #fff;
    z-index: 5;
    font-size: 14px;
  }

  canvas { display:block; }
</style>

</head>
<body>

<div id="uiTop">Sağ tuş basılı tut → Kamera döner | W A S D → Hareket</div>

<!-- THREE.JS + POSTPROCESSING -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/loaders/RGBELoader.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/RenderPass.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js"></script>

<script>
/* ----------------------------------------------
   SAHNE – MOTOR BAŞLANGICI
------------------------------------------------*/
const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(
  60,
  window.innerWidth / window.innerHeight,
  0.1,
  2000
);

camera.position.set(0, 6, 12);

/* ----------------------------------------------
   RENDER – YÜKSEK KALİTE
------------------------------------------------*/
const renderer = new THREE.WebGLRenderer({
  antialias: true,
  powerPreference: "high-performance"
});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.outputEncoding = THREE.sRGBEncoding;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.2;
document.body.appendChild(renderer.domElement);

/* ----------------------------------------------
   HDRI GÖKYÜZÜ YÜKLEME
------------------------------------------------*/
new THREE.RGBELoader()
  .setDataType(THREE.UnsignedByteType)
  .load(
    "https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/snowy_forest_path_01_1k.hdr",
    (texture) => {
      texture.mapping = THREE.EquirectangularReflectionMapping;
      scene.environment = texture;
      scene.background = texture;
    }
  );

/* ----------------------------------------------
   IŞIKLANDIRMA (Gerçekçi)
------------------------------------------------*/
const dirLight = new THREE.DirectionalLight(0xffffff, 1.4);
dirLight.position.set(20, 40, 20);
dirLight.castShadow = true;
scene.add(dirLight);

const fillLight = new THREE.AmbientLight(0xffffff, 0.35);
scene.add(fillLight);

/* ----------------------------------------------
   GERÇEKÇİ KAR ZEMİNİ (PBR)
------------------------------------------------*/
const snowGeo = new THREE.PlaneGeometry(400, 400);

const snowTex = new THREE.TextureLoader().load("https://threejs.org/examples/textures/terrain/grasslight-big.jpg");
snowTex.wrapS = snowTex.wrapT = THREE.RepeatWrapping;
snowTex.repeat.set(40, 40);

const snowMat = new THREE.MeshStandardMaterial({
  color: 0xffffff,
  roughness: 0.9,
  metalness: 0.1
});

const ground = new THREE.Mesh(snowGeo, snowMat);
ground.rotation.x = -Math.PI / 2;
ground.receiveShadow = true;
scene.add(ground);

/* ----------------------------------------------
   KARI YAĞDIRAN PARÇACIK SİSTEMİ
------------------------------------------------*/
const snowCount = 1600;
const snowPositions = new Float32Array(snowCount * 3);

for (let i = 0; i < snowCount; i++) {
  snowPositions[i * 3]     = (Math.random() - 0.5) * 300;
  snowPositions[i * 3 + 1] = Math.random() * 80 + 10;
  snowPositions[i * 3 + 2] = (Math.random() - 0.5) * 300;
}

const snowGeometry = new THREE.BufferGeometry();
snowGeometry.setAttribute("position", new THREE.BufferAttribute(snowPositions, 3));

const snowMaterial = new THREE.PointsMaterial({
  color: 0xffffff,
  size: 0.35,
  transparent: true
});

const snowPoints = new THREE.Points(snowGeometry, snowMaterial);
scene.add(snowPoints);

/* ----------------------------------------------
   OTMAN SAHNESİ – ŞİMDİLİK GEÇİCİ MODEL
   (AŞAMA 2’de gerçek model + animasyon gelecek)
------------------------------------------------*/
const otman = new THREE.Group();

const bodyGeo = new THREE.CapsuleGeometry(0.7, 1.8, 6, 12);
const bodyMat = new THREE.MeshStandardMaterial({ color: 0x2f66ff });
const body = new THREE.Mesh(bodyGeo, bodyMat);
body.castShadow = true;
body.position.y = 1.8;
otman.add(body);

const headGeo = new THREE.SphereGeometry(0.55, 24, 24);
const headMat = new THREE.MeshStandardMaterial({ color: 0xffe0bd });
const head = new THREE.Mesh(headGeo, headMat);
head.position.y = 3.1;
otman.add(head);

otman.position.set(0, 0, 0);
scene.add(otman);

/* ----------------------------------------------
   SAĞ TIK MOUSE KAMERA KONTROLÜ (Valorant-benzeri)
------------------------------------------------*/
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.target = otman.position;
controls.enableDamping = true;
controls.dampingFactor = 0.1;
controls.enablePan = false;
controls.enableZoom = true;
controls.minDistance = 6;
controls.maxDistance = 20;
controls.rotateSpeed = 0.8;

let rightMouseDown = false;

document.addEventListener("mousedown", (e) => {
  if (e.button === 2) rightMouseDown = true;
});

document.addEventListener("mouseup", (e) => {
  if (e.button === 2) rightMouseDown = false;
});

// Sağ tık yoksa kamera dönmez
controls.enableRotate = false;

/* ----------------------------------------------
   KLAVYE KONTROLLERİ – HAREKET
------------------------------------------------*/
const keys = {};
document.addEventListener("keydown", (e) => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", (e) => keys[e.key.toLowerCase()] = false);

/* ----------------------------------------------
   POST-PROCESSING (Bloom)
------------------------------------------------*/
const composer = new THREE.EffectComposer(renderer);
composer.addPass(new THREE.RenderPass(scene, camera));

const bloom = new THREE.UnrealBloomPass(
  new THREE.Vector2(window.innerWidth, window.innerHeight),
  0.35,
  0.4,
  0.3
);
composer.addPass(bloom);

/* ----------------------------------------------
   ANİMASYON DÖNGÜSÜ
------------------------------------------------*/
let last = performance.now();

function animate() {
  requestAnimationFrame(animate);

  // Zaman hesapla
  const now = performance.now();
  const dt = (now - last) / 1000;
  last = now;

  // Mouse sağ tık ile kamera dönebilir
  controls.enableRotate = rightMouseDown;

  // Kar yağışı hareketi
  const pos = snowGeometry.attributes.position;
  for (let i = 0; i < snowCount; i++) {
    let y = pos.getY(i);
    y -= dt * (4 + Math.random() * 1.5);
    if (y < 0) y = 60 + Math.random() * 20;
    pos.setY(i, y);
  }
  pos.needsUpdate = true;

  // OTMAN hareketi
  let speed = 6;
  let vx = 0, vz = 0;

  if (keys["w"]) vz -= 1;
  if (keys["s"]) vz += 1;
  if (keys["a"]) vx -= 1;
  if (keys["d"]) vx += 1;

  if (vx !== 0 || vz !== 0) {
    const len = Math.hypot(vx, vz);
    vx /= len; vz /= len;

    otman.position.x += vx * speed * dt;
    otman.position.z += vz * speed * dt;

    // Otman'ın baktığı yön
    otman.rotation.y = Math.atan2(vx, vz);

    // Kamera hedefi güncelle
    controls.target.copy(otman.position);
  }

  controls.update();
  composer.render();
}

animate();

/* ----------------------------------------------
   PENCERE BOYUTU
------------------------------------------------*/
window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  composer.setSize(window.innerWidth, window.innerHeight);
});

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Otman 3D – Uyanış Sahnesi</title>

<style>
  html, body {
    margin: 0;
    overflow: hidden;
    width: 100%;
    height: 100%;
    background: #000;
    font-family: sans-serif;
  }

  #uiTop {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 16px;
    background: rgba(0,0,0,0.45);
    border-radius: 10px;
    color: #fff;
    z-index: 5;
    font-size: 14px;
    display: none; /* Cinematic bitene kadar gizli */
  }

  canvas { display:block; }
</style>

</head>
<body>

<div id="uiTop">W A S D → Hareket • Sağ Tık → Kamera Döndür • Shift → Koş</div>

<!-- THREE.JS -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/loaders/RGBELoader.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/RenderPass.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js"></script>

<script>
/* =====================================================
   SAHNE & RENDER AYARLARI
===================================================== */
const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(
  60,
  window.innerWidth / window.innerHeight,
  0.1,
  2000
);

camera.position.set(0, 2, 2);

const renderer = new THREE.WebGLRenderer({
  antialias: true,
  powerPreference: "high-performance"
});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.outputEncoding = THREE.sRGBEncoding;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.2;
document.body.appendChild(renderer.domElement);

/* =====================================================
   HDRI GÖKYÜZÜ
===================================================== */
new THREE.RGBELoader()
  .setDataType(THREE.UnsignedByteType)
  .load("https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/snowy_forest_path_01_1k.hdr", (texture) => {
    texture.mapping = THREE.EquirectangularReflectionMapping;
    scene.environment = texture;
    scene.background = texture;
  });

/* =====================================================
   IŞIKLANDIRMA
===================================================== */
scene.add(new THREE.AmbientLight(0xffffff, 0.55));

const dirLight = new THREE.DirectionalLight(0xffffff, 1.3);
dirLight.position.set(20, 40, 20);
dirLight.castShadow = true;
scene.add(dirLight);

/* =====================================================
   EVİN İÇİ – DUVARLAR & KIRIK BÖLÜM
===================================================== */
const wallMat = new THREE.MeshStandardMaterial({ color: 0xbcbcbc, roughness: 0.8 });

function wall(w, h, d, x, y, z, broken=false) {
  const g = new THREE.BoxGeometry(w, h, d);

  if (broken) {
    // Duvarın bir kısmını kırık göstermek için noise verelim
    for (let i = 0; i < g.attributes.position.count; i++) {
      let vx = g.attributes.position.getX(i);
      if (vx > 0) {
        g.attributes.position.setX(i, vx + (Math.random() * 0.5));
      }
    }
  }

  const m = new THREE.Mesh(g, wallMat);
  m.position.set(x, y, z);
  m.castShadow = true;
  scene.add(m);
}

// Arka duvar
wall(8, 4, 0.3, 0, 2, -4);

// Sol duvar
wall(0.3, 4, 8, -4, 2, 0);

// Sağ duvar (KIRIK)
wall(0.3, 4, 8, 4, 2, 0, true);

// Ön duvar yok – çünkü evin yarısı yok olmuş.

/* =====================================================
   ZEMİN & KAR KAPLAMASI
===================================================== */
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(30, 30),
  new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.9 })
);
ground.rotation.x = -Math.PI / 2;
scene.add(ground);

/* =====================================================
   YATAK MODELİ
===================================================== */
const bed = new THREE.Group();

const base = new THREE.Mesh(
  new THREE.BoxGeometry(2, 0.4, 1),
  new THREE.MeshStandardMaterial({ color: 0x8c5a3c })
);
base.position.y = 0.2;
bed.add(base);

const mattress = new THREE.Mesh(
  new THREE.BoxGeometry(2, 0.3, 1),
  new THREE.MeshStandardMaterial({ color: 0xe9e4dd })
);
mattress.position.y = 0.6;
bed.add(mattress);

bed.position.set(0, 0, 0);
scene.add(bed);

/* =====================================================
   OTMAN MODELİ (YATAKTA)
===================================================== */
const otman = new THREE.Group();

const body = new THREE.Mesh(
  new THREE.CapsuleGeometry(0.4, 1.3, 6, 12),
  new THREE.MeshStandardMaterial({ color: 0x4477ff })
);
body.position.y = 1.1;
otman.add(body);

const head = new THREE.Mesh(
  new THREE.SphereGeometry(0.35, 24, 24),
  new THREE.MeshStandardMaterial({ color: 0xffe0bd })
);
head.position.y = 1.9;
otman.add(head);

// Otman yatay dursun
otman.rotation.x = Math.PI / 2;
otman.position.set(0, 0.8, 0);

scene.add(otman);

/* =====================================================
   SİNEMATİK KAMERA – UYANIŞ
===================================================== */
let cinematic = true;
let cinematicTime = 0;

// “OTMAAAN” sesi
const audio = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_8b69294883.mp3?filename=dark-ambient-gong-140274.mp3");

function runCinematic(dt) {
  cinematicTime += dt;

  // 0–2 saniye: kamera yatay
  if (cinematicTime < 2) {
    camera.position.set(0, 1.2, 1.5);
    camera.lookAt(0, 1.2, 0);
  }

  // 2–6 saniye: kamera yavaşça yukarı kalkıyor
  if (cinematicTime >= 2 && cinematicTime < 6) {
    let t = (cinematicTime - 2) / 4;
    camera.position.set(0, 1.2 + t * 2, 1.5 + t * 1.2);
    camera.lookAt(0, 1.2 + t * 1.5, 0);
  }

  // 3. saniyede yankı gelsin
  if (cinematicTime > 3 && cinematicTime < 3.2) audio.play();

  // 6. saniye → Otman ayağa kalkar
  if (cinematicTime >= 6 && cinematicTime < 6.1) {
    otman.rotation.x = 0;
    otman.position.z = -1;
  }

  // 6–8 saniye: Otman'ın olduğu alana yaklaş
  if (cinematicTime >= 6 && cinematicTime < 8) {
    let t = (cinematicTime - 6) / 2;
    camera.position.set(0, 3, 4 - t * 2);
    camera.lookAt(0, 1.8, -1);
  }

  // 8. saniye → Sinematik biter
  if (cinematicTime >= 8) {
    cinematic = false;
    document.getElementById("uiTop").style.display = "block";
  }
}

/* =====================================================
   KLAVYE + KAMERA KONTROLLERİ
===================================================== */
const keys = {};
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

let rightMouse = false;
document.addEventListener("mousedown", e => {
  if (e.button === 2) rightMouse = true;
});
document.addEventListener("mouseup", e => {
  if (e.button === 2) rightMouse = false;
});

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.target = new THREE.Vector3(0, 1.8, -1);
controls.enablePan = false;
controls.enableZoom = true;
controls.enableRotate = false;
controls.minDistance = 4;
controls.maxDistance = 12;

/* =====================================================
   ANİMASYON DÖNGÜSÜ
===================================================== */
let last = performance.now();

function animate() {
  requestAnimationFrame(animate);

  let now = performance.now();
  let dt = (now - last) / 1000;
  last = now;

  if (cinematic) {
    runCinematic(dt);
  } else {
    // Normal oyun kontrolü
    controls.enableRotate = rightMouse;

    let vx = 0, vz = 0;
    let speed = 5;

    if (keys["w"]) vz -= 1;
    if (keys["s"]) vz += 1;
    if (keys["a"]) vx -= 1;
    if (keys["d"]) vx += 1;

    if (vx !== 0 || vz !== 0) {
      const len = Math.hypot(vx, vz);
      vx /= len; vz /= len;

      otman.position.x += vx * speed * dt;
      otman.position.z += vz * speed * dt;

      otman.rotation.y = Math.atan2(vx, vz);

      controls.target.copy(otman.position).add(new THREE.Vector3(0,1.8,0));
    }

    controls.update();
  }

  renderer.render(scene, camera);
}

animate();

/* =====================================================
   EKRAN BOYUTU
===================================================== */
window.addEventListener("resize", ()=>{
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
/* =====================================================
   AŞAMA 3 — KAR İSKELETLERİ & SAVAŞ SİSTEMİ
===================================================== */

// Düşman dizisi
let skeletons = [];
let battleStarted = false;
let attackCooldown = 0;

// İskelet oluşturma fonksiyonu
function spawnSkeleton(x, z) {
  const skel = new THREE.Group();

  const boneMat = new THREE.MeshStandardMaterial({
    color: 0xffffff,
    roughness: 0.6,
    metalness: 0.0
  });

  // Gövde
  const torso = new THREE.Mesh(
    new THREE.CapsuleGeometry(0.4, 1.0, 6, 12),
    boneMat
  );
  torso.position.y = 1.4;
  skel.add(torso);

  // Kafatası
  const skull = new THREE.Mesh(
    new THREE.SphereGeometry(0.45, 20, 20),
    boneMat
  );
  skull.position.y = 2.3;
  skel.add(skull);

  // Bacaklar
  const legGeo = new THREE.CylinderGeometry(0.15, 0.15, 1.0, 12);
  const legL = new THREE.Mesh(legGeo, boneMat);
  legL.position.set(-0.25, 0.5, 0);
  const legR = legL.clone();
  legR.position.x = 0.25;
  skel.add(legL, legR);

  // Kollar
  const armGeo = new THREE.CylinderGeometry(0.12, 0.12, 0.9, 12);
  const armL = new THREE.Mesh(armGeo, boneMat);
  armL.position.set(-0.55, 1.7, 0);
  const armR = armL.clone();
  armR.position.x = 0.55;
  skel.add(armL, armR);

  // Gölge
  const shadow = new THREE.Mesh(
    new THREE.CircleGeometry(0.8, 16),
    new THREE.MeshBasicMaterial({
      color: 0x000000,
      transparent: true,
      opacity: 0.34
    })
  );
  shadow.rotation.x = -Math.PI / 2;
  shadow.position.y = 0.01;
  skel.add(shadow);

  // Pozisyon
  skel.position.set(x, 0, z);

  // İskelet nesnesi
  const skeleton = {
    group: skel,
    hp: 3,
    alive: true
  };

  skeletons.push(skeleton);
  scene.add(skel);
}

/* =====================================================
   KÖPRÜ AÇILDIKTAN SONRA DÜŞMANLARI SPAWN ET
===================================================== */
function startBattle() {
  if (battleStarted) return;
  battleStarted = true;

  // Üç adet kar iskeleti çağır
  spawnSkeleton(-6, -42);
  spawnSkeleton(0, -45);
  spawnSkeleton(6, -42);

  showMission("Kar iskeletlerini yok et! Space → Saldırı");
}

/* =====================================================
   SALDIRI SİSTEMİ
===================================================== */
function playerAttack(dt) {
  if (attackCooldown > 0) {
    attackCooldown -= dt;
    if (attackCooldown < 0) attackCooldown = 0;
  }

  // Space'e basıldıysa
  if (keys[" "] && attackCooldown === 0) {
    attackCooldown = 0.5;

    const attackRange = 3;

    skeletons.forEach(s => {
      if (!s.alive) return;

      const dx = s.group.position.x - otman.position.x;
      const dz = s.group.position.z - otman.position.z;
      const dist = Math.hypot(dx, dz);

      if (dist < attackRange) {
        s.hp -= 1;

        // Hit efekti
        s.group.scale.setScalar(1 + (3 - s.hp) * 0.08);

        // Öldü mü?
        if (s.hp <= 0) {
          s.alive = false;
          scene.remove(s.group);
        }
      }
    });
  }
}

/* =====================================================
   İSKELETLERİN OYUNCUYA YÜRÜMESİ
===================================================== */
function updateSkeletons(dt) {
  skeletons.forEach(s => {
    if (!s.alive) return;

    const dx = otman.position.x - s.group.position.x;
    const dz = otman.position.z - s.group.position.z;
    const dist = Math.hypot(dx, dz);

    if (dist > 1.2) {
      const speed = 4 * dt;
      s.group.position.x += (dx / dist) * speed;
      s.group.position.z += (dz / dist) * speed;
    }

    s.group.rotation.y = Math.atan2(dx, dz);
  });
}

/* =====================================================
   TÜM İSKELETLER ÖLDÜ → GÖREV TAMAMLANDI
===================================================== */
function checkBattleEnd() {
  if (!battleStarted) return;

  if (skeletons.length > 0 && skeletons.every(s => !s.alive)) {
    showMission("Görev tamamlandı! Otman: \"Bu sadece başlangıç...\"");
  }
}
